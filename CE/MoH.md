""" File Name: MoH.py Description: Script for upload the raw data to ThingsBoards platform and optionally computes the MoH metric. Author: Rubén Rodríguez Navarro Creation Date: 2025-07-28 Last Modified Date: 2025-08-10 Version: 1.2.0 License: Apache 2.0 Notes: - It's mandatory use a token ID for reference the node which will have the data. """ import pandas as pd import requests import time import argparse import os import sys # --- Rounding function --- def round\_to(num, decimals): """A Python implementation of the JavaScript Math.round-like function.""" if isinstance(num, (int, float)): return round(num \* (10 \*\* decimals)) / (10 \*\* decimals) return num # --- Send data to ThingsBoard --- def send\_data(df, telemetry\_keys, token, host): url = f'{host}/api/v1/{token}/telemetry' headers = {'Content-Type': 'application/json'} print(f"Load {len(df)} registries from CSV.") total\_records = len(df) for index, row in df.iterrows(): timestamp\_ms = int(row\['Timestamp'\].timestamp() \* 1000) values = {} for key in telemetry\_keys: if key in row and pd.notnull(row\[key\]): values\[key\] = row\[key\] payload = { "ts": timestamp\_ms, "values": values } try: response = requests.post(url, headers=headers, json=payload) response.raise\_for\_status() if index % 100 == 0: # Updated progress message print(f"Progress: Records sent {index+1}/{total\_records}.") except requests.exceptions.RequestException as e: print(f"Fail to send a data to ThingsBoard: {e}") print(f"Payload fails: {payload}") except Exception as e: print(f"Unexpected error in row {index}: {e}") print(f"Payload number: {payload}") print("Process success.") # --- Function for send the oscilation to ThingsBoard --- def send\_oscillation(df\_oscillation, token, host): url = f'{host}/api/v1/{token}/telemetry' headers = {'Content-Type': 'application/json'} print(f"Load {len(df\_oscillation)} records to send.") for index, row in df\_oscillation.iterrows(): timestamp\_ms = int(index.timestamp() \* 1000) values = {col: round\_to(row\[col\], 3) for col in df\_oscillation.columns if pd.notnull(row\[col\])} payload = { "ts": timestamp\_ms, "values": values } try: response = requests.post(url, headers=headers, json=payload) response.raise\_for\_status() print(f"Progress sending oscillations: {index}. Data: {values}") except requests.exceptions.RequestException as e: print(f"Error sending oscillation data to ThingsBoard: {e}") print(f"Payload failed: {payload}") except Exception as e: print(f"Unexpected error sending oscillation with index {index}: {e}") print(f"Payload failed: {payload}") print("Send oscillation succed.") # --- Load data to CSV --- def load\_csv(csv\_path): try: if not os.path.exists(csv\_path): raise FileNotFoundError(f"Error: CSV file don't find it {csv\_path}") df = pd.read\_csv(csv\_path, sep=';') if 'Timestamp' not in df.columns: raise KeyError("Error: Cannot find 'Timestamp' column into CSV.") df\['Timestamp'\] = pd.to\_datetime(df\['Timestamp'\]) df = df.sort\_values(by='Timestamp') df = df.set\_index('Timestamp') return df except KeyError as e: print(f"Error: Missing column into CSV. Details: {e}") sys.exit(1) except Exception as e: print(f"Cannot read the CSV: {e}") sys.exit(1) def keys\_validation(df, keys): missing\_keys = \[key for key in keys if key not in df.columns\] if missing\_keys: raise KeyError(f"Error: Missing keys into CSV: {', '.join(missing\_keys)}") # --- Function for calculate the MoH --- def MoH\_calculation(df, telemetry\_keys): print("Processing ...") oscillation\_df = pd.DataFrame() for key in telemetry\_keys: if key in df.columns: # Obteining a min, max with an interval of one hour df\[key\] = pd.to\_numeric(df\[key\], errors='coerce') hourly\_min = df\[key\].resample('H').min() hourly\_max = df\[key\].resample('H').max() # Diference between max and min oscillation = hourly\_max - hourly\_min # Assing a descriptive name for variable oscillation\_df\[f'{key}\_MoH'\] = oscillation else: print(f"Warning: The key '{key}' not found into DataFrame. MoH will not be computed for this key.") oscillation\_df = oscillation\_df.dropna() print("Finish the compute of MoH.") return oscillation\_df # --- Function to filter data by time period --- def filter\_by\_time(df, time\_filter): try: end\_time = df.index.max() period = time\_filter\[-1\].upper() number = int(time\_filter\[:-1\]) if period == 'D': start\_time = end\_time - pd.DateOffset(days=number) elif period == 'M': start\_time = end\_time - pd.DateOffset(months=number) elif period == 'Y': start\_time = end\_time - pd.DateOffset(years=number) else: print(f"Invalid time filter format: '{time\_filter}'. Using all data.") return df filtered\_df = df\[df.index >= start\_time\] print(f"Data filtered from {start\_time} to {end\_time}.") return filtered\_df except (ValueError, IndexError): print(f"Invalid time filter format: '{time\_filter}'. Using all data.") return df except Exception as e: print(f"Error during time filtering: {e}. Using all data.") return df # --- Main --- def main(): parser = argparse.ArgumentParser(description="Upload telemetries to ThingsBoard with CSV file with MoH implementation") if len(sys.argv) == 1: parser.print\_help(sys.stderr) sys.exit(1) parser.add\_argument('--csv', required=True, help='Requires absolute path locates') parser.add\_argument('--keys', nargs='+', help='List of parameters to send (ex. --keys "Temperature" "Relative humidity")') parser.add\_argument('--token', help='ThingsBoard access token') parser.add\_argument('--host', default='http://localhost:8080', help='ThingsBoard URL API (default: http://localhost:8080)') parser.add\_argument('--list-columns', action='store\_true', help='List of parameters contained into CSV') parser.add\_argument('--moh', action='store\_true', help='Compute and send MoH telemetry') parser.add\_argument('--time-filter', help='Filter data by a specific time period (e.g., "7D" for 7 days, "1M" for 1 month)') args = parser.parse\_args() try: df = load\_csv(args.csv) if args.list\_columns: print("Parameters into CSV:") print(" - " + "\\n - ".join(col for col in df.columns)) sys.exit(0) if not args.keys: print("Error: You should give at least one key --keys or use --list-columns for obtain the available parameters.") parser.print\_help(sys.stderr) sys.exit(1) if not args.token: print("Error: You should give a token ID --token.") parser.print\_help(sys.stderr) sys.exit(1) if args.time\_filter: df = filter\_by\_time(df, args.time\_filter) keys\_validation(df.reset\_index(), args.keys) send\_data(df.reset\_index(), args.keys, args.token, args.host) if args.moh: moh\_df = MoH\_calculation(df, args.keys) if not moh\_df.empty: send\_oscillation(moh\_df, args.token, args.host) else: print("MOH data empty.") except FileNotFoundError as e: print(f"File error: {e}") sys.exit(1) except KeyError as e: print(f"Column error into CSV: {e}") sys.exit(1) except Exception as e: print(f"Load error: {e}") sys.exit(1) if \_\_name\_\_ == '\_\_main\_\_': main()